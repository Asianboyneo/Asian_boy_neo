<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- iOS Ë¶ñÂè£ÂÑ™Âåñ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cosmic Particles (Unified Space Glass UI)</title>
    
    <!-- ÂºïÂÖ• Font Awesome ÂúñÊ®ôÂ∫´ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- Ê®£ÂºèË®≠Ë®à -->
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #020205;
            /* Áèæ‰ª£ÁÑ°Ë•ØÁ∑öÂ≠óÈ´îÔºå‰πæÊ∑®ÂÑ™ÈõÖ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            height: 100dvh; 
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #video-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }

        /* --- Â§™Á©∫ÊØõÁéªÁíÉ UI Ê†∏ÂøÉË®≠Ë®à (Â∑¶‰∏ãËßíÈù¢Êùø) --- */
        #ui-layer {
            position: absolute;
            bottom: 30px;
            left: 20px;
            max-width: 350px;
            width: calc(100% - 40px);
            
            color: rgba(255, 255, 255, 0.95);
            z-index: 10;
            pointer-events: none; /* ËÆìÊï¥ÂÄãÈù¢Êùø‰∏çÈòªÊìãÊªëÈº†Ôºå‰ΩÜÂ≠êÂÖÉÁ¥†Ë¶ÅÈñãÂïü */
            
            /* Â§™Á©∫ÊÑüÊ∑±Ëâ≤ÂçäÈÄèÊòéËÉåÊôØ */
            background: rgba(20, 25, 40, 0.4); 
            /* Âº∑ÂäõÊ®°Á≥äÁî¢ÁîüÊ∑±Â∫¶ÊÑü */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            
            padding: 24px;
            border-radius: 24px;
            
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(0, 0, 0, 0.2);
            
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.4),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        /* ËÆìÈù¢ÊùøÂÖßÁöÑ‰∫íÂãïÂÖÉÁ¥†ÂèØ‰ª•Ë¢´ÈªûÊìä */
        #ui-layer > * {
            pointer-events: auto;
        }

        h1 {
            font-weight: 300;
            margin: 0 0 12px 0;
            font-size: 1.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(120deg, #ffffff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            padding-bottom: 12px;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 2px;
            background: rgba(165, 180, 252, 0.5);
            border-radius: 2px;
        }

        /* --- Èù¢ÊùøÂÖßÁöÑÁ§æÁæ§ÊåâÈàïÂàó --- */
        .social-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px; 
            pointer-events: auto; 
        }

        .social-btn {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .social-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(165, 180, 252, 0.3);
            border-color: rgba(165, 180, 252, 0.4);
        }

        .social-btn:hover .fa-instagram { color: #e1306c; }
        .social-btn:hover .fa-youtube { color: #ff0000; }
        .social-btn:hover .fa-threads { color: #fff; } 
        .social-btn:hover .fa-mug-hot { color: #13C3FF; } 

        p {
            margin: 6px 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            font-weight: 400;
        }

        .highlight {
            color: #a5b4fc;
            font-weight: 500;
            text-shadow: 0 0 15px rgba(165, 180, 252, 0.4);
        }

        /* --- Â∫ïÈÉ®Ë≥áË®äËàáÊåâÈàïÂàó --- */
        .ui-footer-row {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-count-container {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
        }
        
        .view-count-num {
            color: #a5b4fc;
            font-weight: 600;
            margin-left: 6px;
            text-shadow: 0 0 8px rgba(165, 180, 252, 0.4);
        }

        /* Reset ÊåâÈàïÊ®£Âºè */
        .reset-btn {
            background: transparent;
            border: 1px solid rgba(165, 180, 252, 0.3);
            color: rgba(165, 180, 252, 0.8);
            border-radius: 6px;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
            outline: none;
            pointer-events: auto; /* Á¢∫‰øùÊåâÈàïÂèØÈªûÊìä */
        }

        .reset-btn:hover {
            background: rgba(165, 180, 252, 0.15);
            color: #fff;
            border-color: #a5b4fc;
            box-shadow: 0 0 12px rgba(165, 180, 252, 0.4);
            transform: translateY(-1px);
        }

        .reset-btn:active {
            transform: translateY(0);
        }

        /* --- lil-gui Â§™Á©∫ÊØõÁéªÁíÉÈ¢®Ê†º --- */
        .lil-gui { 
            --background-color: rgba(20, 25, 40, 0.4);
            --text-color: rgba(255, 255, 255, 0.95);
            --title-background-color: transparent;
            --widget-color: rgba(255, 255, 255, 0.1);
            --hover-color: rgba(255, 255, 255, 0.2);
            --focus-color: rgba(255, 255, 255, 0.3);
            --number-color: #a5b4fc;
            --string-color: #6ee7b7;
            
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            
            border-radius: 24px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.2) !important;
            
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.4),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05) !important;
                
            padding-bottom: 15px;
        }
        
        .lil-gui .title {
            height: 40px;
            line-height: 40px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #a5b4fc; 
            text-shadow: 0 0 15px rgba(165, 180, 252, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: transparent;
            text-align: center;
        }

        .lil-gui .children {
            padding: 10px;
        }
        
        .lil-gui.autoPlace {
            top: 30px !important;
            right: 20px !important;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1rem;
            z-index: 20;
            transition: opacity 1s ease;
            text-align: center;
            width: 80%;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
            font-weight: 300;
            letter-spacing: 3px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #fb7185; 
            margin-right: 10px;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(251, 113, 133, 0.5);
            vertical-align: middle;
            transition: all 0.5s ease;
            position: relative;
        }
        
        .status-dot::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 1px solid currentColor;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }

        .status-active { background-color: #4ade80; box-shadow: 0 0 15px rgba(74, 222, 128, 0.6); color: #4ade80; }
        .status-inactive { background-color: #94a3b8; box-shadow: none; color: #94a3b8; }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .divider {
            margin-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 12px;
        }

        /* --- ÊâãÊ©üÁâàÈüøÊáâÂºèÂÑ™Âåñ --- */
        @media (max-width: 600px) {
            #ui-layer {
                bottom: 20px;
                bottom: calc(20px + env(safe-area-inset-bottom));
                left: 10px;
                width: calc(100% - 20px);
                padding: 15px;            
                border-radius: 16px;
            }
            
            #ui-layer h1 {
                font-size: 1.2rem;
                margin-bottom: 8px;
                padding-bottom: 8px;
            }
            
            .social-btn {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }
            
            .social-row {
                margin-bottom: 10px;
                gap: 8px;
            }
            
            #ui-layer p, .view-count-container, .reset-btn {
                font-size: 0.8rem;
            }
            
            .divider {
                margin-top: 10px;
                padding-top: 8px;
            }

            .lil-gui.autoPlace {
                top: 15px !important;
                right: 15px !important;
                max-width: 160px;
            }
            
            .lil-gui {
                --width: 160px;
                font-size: 11px;
            }
            
            .lil-gui .title {
                height: 28px;
                line-height: 28px;
                font-size: 11px;
            }
            
            .lil-gui .children {
                padding: 5px;
            }
        }
    </style>

    <!-- ÂºïÂÖ• MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- Import Map for Three.js and Firebase -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading">Initializing Quantum Field...<br><span style="font-size:0.7em; opacity:0.6; letter-spacing: 1px;">Awaiting Input</span></div>

    <div id="ui-layer">
        <h1>ASIAN BOY VISION</h1>
        
        <!-- Á§æÁæ§ÊåâÈàï -->
        <div class="social-row">
            <a href="https://www.instagram.com/asian_boy_neo" target="_blank" class="social-btn" title="Instagram">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="https://www.youtube.com/@asian_boy_neo" target="_blank" class="social-btn" title="YouTube">
                <i class="fab fa-youtube"></i>
            </a>
            <a href="https://www.threads.com/@asian_boy_neo?hl=zh-tw" target="_blank" class="social-btn" title="Threads">
                <i class="fa-brands fa-threads"></i>
            </a>
            <a href="https://ko-fi.com/asianboyneo" target="_blank" class="social-btn" title="Ko-fi">
                <i class="fa-solid fa-mug-hot"></i>
            </a>
        </div>

        <p><span id="cam-status" class="status-dot"></span><span id="status-text">Camera Standby</span></p>
        
        <!-- Êìç‰ΩúË™™Êòé (ÈñãÂïüÁõ∏Ê©üÂæåÈ°ØÁ§∫) -->
        <div class="divider" id="gesture-instructions" style="display: none;">
            <p>üñêÔ∏è <span class="highlight">Move</span> to Rotate</p>
            <p>üëã <span class="highlight">Distance</span> to Zoom</p>
            <p>üëå <span class="highlight">Pinch</span> to Explode</p>
        </div>
        
        <!-- Â∫ïÈÉ®ÂçÄÂüüÔºöÁÄèË¶ΩÊ¨°Êï∏ (Â∑¶) + Reset ÊåâÈàï (Âè≥) -->
        <div class="ui-footer-row">
            <div class="view-count-container">
                <i class="fas fa-eye" style="margin-right: 5px;"></i> Views: <span id="view-counter" class="view-count-num">---</span>
            </div>
            
            <button id="btn-reset" class="reset-btn" title="Reset View">
                <i class="fas fa-sync-alt"></i> Reset
            </button>
        </div>
    </div>

    <!-- Èö±ËóèÁöÑÊñá‰ª∂‰∏äÂÇ≥Ëº∏ÂÖ•Ê°Ü -->
    <input type="file" id="file-input" style="display: none;" accept="image/*">

    <video id="video-input" playsinline muted autoplay></video>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ÂÖ®Â±ÄËÆäÈáè ---
        let scene, camera, renderer, composer, controls;
        let particles, geometry, material;
        let time = 0;
        let currentImageData = null; 
        
        let cameraUtils; 
        let isCameraActive = false; 
        
        // ÈñãÂ†¥ÂãïÁï´ÁãÄÊÖãÊóóÊ®ô
        let isIntroAnimation = true;

        // È†êË®≠ÂúñÁâáË∑ØÂæë
        const DEFAULT_IMAGE_PATH = '287069905_564270111773809_6459526836966162411_n.jpg';

        // --- Êñ∞Â¢ûÔºöÈö®Ê©üË®≠ÂÆöÁõ∏Ê©üÁôºÂ∞Ñ‰ΩçÁΩÆÁöÑËºîÂä©ÂáΩÂºè ---
        function setRandomLaunchPosition() {
            // Ë®≠ÂÆö‰∏ÄÂÄãÊ•µÈÅ†ÁöÑÂçäÂæëÁØÑÂúç (‰æãÂ¶Ç 2000~3000)
            const r = 2000 + Math.random() * 1000;
            
            // ÁêÉÈù¢Â∫ßÊ®ôÈö®Ê©üÂèñÈªû
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos((Math.random() * 2) - 1);
            
            // ËΩâÊèõÁÇ∫Á¨õÂç°ÂÖíÂ∫ßÊ®ô (X, Y, Z)
            camera.position.x = r * Math.sin(phi) * Math.cos(theta);
            camera.position.y = r * Math.sin(phi) * Math.sin(theta);
            camera.position.z = r * Math.cos(phi);
            
            // Á¢∫‰øùÁõ∏Ê©ü‰∏ÄÈñãÂßãÂ∞±ÁúãËëó‰∏≠ÂøÉÔºåÈÅøÂÖçËø∑Â§±ÊñπÂêë
            camera.lookAt(0, 0, 0);
        }

        const params = {
            count: 80000,          
            size: 306,             
            opacity: 1.0,          
            bloomStrength: 3.0,    
            depthStrength: 60.0,   
            floating: true,       
            floatSpeed: 3.0,       
            
            toggleCamera: function() {
                if (!cameraUtils) return;

                const statusDot = document.getElementById('cam-status');
                const statusText = document.getElementById('status-text');
                const instructions = document.getElementById('gesture-instructions');

                if (isCameraActive) {
                    cameraUtils.stop();
                    isCameraActive = false;
                    handPresent = false; 
                    
                    statusDot.className = 'status-dot status-inactive';
                    statusText.textContent = "Sensors Offline";
                    
                    if(instructions) instructions.style.display = 'none';
                } else {
                    cameraUtils.start().then(() => {
                        isCameraActive = true;
                        statusDot.className = 'status-dot status-active';
                        statusText.textContent = "Sensors Active";
                        
                        if(instructions) instructions.style.display = 'block';
                    });
                    statusDot.className = 'status-dot'; 
                    statusText.textContent = "Initializing...";
                }
            },
            uploadPhoto: function() {
                document.getElementById('file-input').click();
            },
            resetView: function() {
                // ÈáçÁΩÆÊóãËΩâÁõÆÊ®ôËÆäÊï∏
                targetRotationX = 0;
                targetRotationY = 0;
                targetCameraZ = 150;
                
                // ÈáçÁΩÆÁ≤íÂ≠êÊú¨Ë∫´ÁöÑÊóãËΩâËßíÂ∫¶
                if (particles) particles.rotation.set(0, 0, 0);

                // --- Ëß∏ÁôºÈñãÂ†¥Á©øÊ¢≠ÁâπÊïàÈÇèËºØ ---
                // 1. Ë®≠ÂÆöÈö®Ê©üÁôºÂ∞Ñ‰ΩçÁΩÆ (Ê≥®ÊÑèÔºö‰∏çÂëºÂè´ controls.reset())
                setRandomLaunchPosition();
                
                // 2. Êö´ÊôÇÈéñÂÆöÊéßÂà∂Âô®
                controls.enabled = false;
                // Á¢∫‰øùÁõÆÊ®ôÈªûÊ≠∏Èõ∂
                controls.target.set(0, 0, 0);
                
                // 3. ÈñãÂïüÂãïÁï´ÊóóÊ®ô
                isIntroAnimation = true;
            }
        };
        
        let handPresent = false;
        let targetRotationX = 0;
        let targetRotationY = 0;
        let targetCameraZ = 150; 
        let pinchStrength = 0;

        init();
        initFirebase();
        initUI();
        initMediaPipe();
        initFileUpload();
        animate();

        function init() {
            const container = document.getElementById('canvas-container');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020205); 
            scene.fog = new THREE.FogExp2(0x020205, 0.0015);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 20000); 
            
            // ‰øÆÊ≠£ÔºöÂÖàË®≠ÂÆöÂà∞Ê®ôÊ∫ñ‰ΩçÁΩÆ (0, 0, 150)ÔºåËÆì Controls Ë®ò‰ΩèÈÄôÂÄãÊòØ "Home"
            camera.position.set(0, 0, 150);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ 
                antialias: false, 
                powerPreference: "high-performance",
                alpha: false
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
            renderer.toneMapping = THREE.ReinhardToneMapping;
            container.appendChild(renderer.domElement);

            loadDefaultImage();

            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth / 2, window.innerHeight / 2), 
                1.5, 0.4, 0.85
            );
            bloomPass.strength = params.bloomStrength;
            bloomPass.radius = 0.5;
            bloomPass.threshold = 0.1; 

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);
            composer.bloomPass = bloomPass;

            // ÂàùÂßãÂåñ OrbitControls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = false; 
            controls.maxPolarAngle = Math.PI * 0.75;
            controls.minPolarAngle = Math.PI * 0.25;
            controls.enableTouch = true;
            
            // ÂÑ≤Â≠òÁõÆÂâçÁãÄÊÖã (150) ‰ΩúÁÇ∫È†êË®≠Èªû
            controls.saveState();

            // ÈñãÂ†¥ÂãïÁï´ÔºöÊâãÂãïÂ∞áÁõ∏Ê©üÁßªÂà∞Èö®Ê©üÈÅ†Êñπ
            setRandomLaunchPosition();
            
            // ÈñãÂ†¥ÂãïÁï´ÊúüÈñìÊö´ÂÅúÊéßÂà∂
            controls.enabled = false;

            window.addEventListener('resize', onWindowResize);
            
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if(loading) loading.style.opacity = 0;
            }, 1500);
        }

        async function initFirebase() {
            if (typeof __firebase_config === 'undefined') {
                console.warn("Firebase config not found. View counter disabled.");
                document.getElementById('view-counter').textContent = "Offline";
                return;
            }
            
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                const statsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'site_stats');
                const viewDocRef = doc(statsCollection, 'view_counter');

                const docSnap = await getDoc(viewDocRef);
                
                if (docSnap.exists()) {
                    await updateDoc(viewDocRef, { count: increment(1) });
                } else {
                    await setDoc(viewDocRef, { count: 1 });
                }

                onSnapshot(viewDocRef, (doc) => {
                    if (doc.exists()) {
                        const count = doc.data().count;
                        document.getElementById('view-counter').textContent = count.toLocaleString();
                    }
                }, (error) => {
                    console.error("Error watching views:", error);
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('view-counter').textContent = "Error";
            }
        }

        function loadDefaultImage() {
            const statusText = document.getElementById('status-text');
            if(statusText) statusText.textContent = "Loading Default Image...";

            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            img.onload = function() {
                console.log("Default image loaded successfully.");
                processImageToParticles(img, true); 
                if(statusText) statusText.textContent = "Camera Standby";
            };
            img.onerror = function() {
                console.warn("Could not load default image. Falling back to default galaxy.");
                generateParticles(params.count); 
                if(statusText) statusText.textContent = "Camera Standby";
            };
            img.src = DEFAULT_IMAGE_PATH;
        }

        function processImageToParticles(img, isInit = false) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const maxSize = 400; 
            let w = img.width;
            let h = img.height;
            if (w > h && w > maxSize) {
                h = Math.round(h * (maxSize / w));
                w = maxSize;
            } else if (h > maxSize) {
                w = Math.round(w * (maxSize / h));
                h = maxSize;
            }

            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);

            const imageData = ctx.getImageData(0, 0, w, h);
            
            currentImageData = {
                width: w,
                height: h,
                data: imageData.data,
                aspectRatio: img.width / img.height
            };

            generateParticles(params.count, currentImageData);
            
            if (!isInit) {
                // ‰∏äÂÇ≥ÂúñÁâáÂæåÔºå‰ΩøÁî®Èö®Ê©üËßíÂ∫¶ÁôºÂ∞Ñ
                setRandomLaunchPosition();
                
                // ÈáçÁΩÆÁ≤íÂ≠êÊóãËΩâÔºåËÆìÊñ∞ÂúñÁâáÂæûÊ≠£Èù¢ÈñãÂßã
                if (particles) particles.rotation.set(0, 0, 0);
                targetRotationX = 0;
                targetRotationY = 0;

                // ‰øÆÊ≠£Ôºö‰∏çÂëºÂè´ resetÔºåÂè™ÈéñÂÆö‰∏¶Ê≠∏Èõ∂ÁõÆÊ®ô
                controls.enabled = false; 
                controls.target.set(0, 0, 0);
                
                isIntroAnimation = true; // ÈáçÊñ∞ÂïüÂãïÁ©øÊ¢≠ÂãïÁï´ÊóóÊ®ô
            }
        }

        function initUI() {
            // Á∂ÅÂÆöÂ∑¶‰∏ãËßíÈù¢ÊùøÁöÑ Reset ÊåâÈàï
            const resetBtn = document.getElementById('btn-reset');
            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.preventDefault(); // Èò≤Ê≠¢ÊåâÈàïÁÑ¶ÈªûÊÆòÁïô
                    params.resetView();
                    resetBtn.blur();
                });
            }

            const gui = new GUI({ title: 'Control Center' }); 
            if (window.innerWidth < 600) gui.close();

            const folder1 = gui.addFolder('Input Source');
            folder1.add(params, 'toggleCamera').name('üëÅÔ∏è Hand Tracking');
            folder1.add(params, 'uploadPhoto').name('üì∑ Upload Image');
            
            folder1.add(params, 'floating').name('üåä Auto Float');
            folder1.add(params, 'floatSpeed', 0.1, 5.0).name('Float Speed');
            
            folder1.add(params, 'depthStrength', 0, 100).name('3D Depth').onChange(val => {
                if(currentImageData) generateParticles(params.count, currentImageData);
            });

            const folder2 = gui.addFolder('Particle System');
            folder2.add(params, 'count', 5000, 80000, 5000).name('Density').onFinishChange(val => {
                generateParticles(val, currentImageData);
            });
            
            folder2.add(params, 'size', 10, 1000).name('Size').onChange(val => {
                if(material) material.uniforms.uSize.value = val;
            });

            folder2.add(params, 'opacity', 0.1, 1.0).name('Opacity').onChange(val => {
                if(material) material.uniforms.uOpacity.value = val;
            });

            folder2.add(params, 'bloomStrength', 0, 3).name('Glow Intensity').onChange(val => {
                if(composer.bloomPass) composer.bloomPass.strength = val;
            });
        }

        function initFileUpload() {
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        processImageToParticles(img, false); 
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
                this.value = '';
            });
        }

        function generateParticles(count, imgData = null) {
            if (particles) {
                scene.remove(particles);
                particles.geometry.dispose();
            }

            geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const sizes = [];
            const randomness = [];

            const displayWidth = 100;
            const displayHeight = 100;

            if (imgData) {
                let finalWidth, finalHeight;
                if (imgData.aspectRatio >= 1) {
                    finalWidth = displayWidth;
                    finalHeight = displayWidth / imgData.aspectRatio;
                } else {
                    finalWidth = displayHeight * imgData.aspectRatio;
                    finalHeight = displayHeight;
                }

                const data = imgData.data;
                const w = imgData.width;
                const h = imgData.height;

                for (let i = 0; i < count; i++) {
                    const px = Math.floor(Math.random() * w);
                    const py = Math.floor(Math.random() * h);
                    
                    const index = (py * w + px) * 4;
                    
                    const r = data[index] / 255;
                    const g = data[index + 1] / 255;
                    const b = data[index + 2] / 255;
                    const a = data[index + 3];

                    if (a < 20 || (r+g+b) < 0.05) {
                         colors.push(0, 0, 0); 
                    } else {
                        colors.push(r, g, b);
                    }

                    const u = (px / w) - 0.5;
                    const v = (py / h) - 0.5;

                    const x = u * finalWidth;
                    const y = -v * finalHeight; 

                    const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
                    const z = brightness * params.depthStrength; 

                    positions.push(x, y, z);
                    sizes.push(Math.random() * 0.5 + 0.5); 
                    randomness.push(Math.random());
                }

            } else {
                const galaxyColor1 = new THREE.Color('#00ffff');
                const galaxyColor2 = new THREE.Color('#ff00ff');

                for (let i = 0; i < count; i++) {
                    const r = Math.random() * 50;
                    const spinAngle = r * 0.2;
                    const branchAngle = (i % 3) * ((Math.PI * 2) / 3);
                    
                    const randomX = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * (10 - r * 0.1);
                    const randomY = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * (10 - r * 0.1);
                    const randomZ = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * (10 - r * 0.1);

                    const x = Math.cos(spinAngle + branchAngle) * r + randomX;
                    const y = (Math.random() - 0.5) * (r * 0.2) + randomY; 
                    const z = Math.sin(spinAngle + branchAngle) * r + randomZ;

                    positions.push(x, y, z);

                    const mixedColor = galaxyColor1.clone().lerp(galaxyColor2, r / 50);
                    colors.push(mixedColor.r, mixedColor.g, mixedColor.b);

                    sizes.push(Math.random());
                    randomness.push(Math.random());
                }
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            geometry.setAttribute('randomness', new THREE.Float32BufferAttribute(randomness, 1));

            if (!material) {
                material = new THREE.ShaderMaterial({
                    uniforms: {
                        uTime: { value: 0 },
                        uPixelRatio: { value: renderer.getPixelRatio() },
                        uSize: { value: params.size },
                        uOpacity: { value: params.opacity }, 
                        uPinch: { value: 0 }
                    },
                    vertexShader: `
                        uniform float uTime;
                        uniform float uPixelRatio;
                        uniform float uSize;
                        uniform float uPinch;
                        
                        attribute float size;
                        attribute float randomness;
                        attribute vec3 color;
                        
                        varying vec3 vColor;

                        void main() {
                            vec3 pos = position;
                            
                            // ‰øùÊåÅÂëºÂê∏ÊïàÊûú
                            float wave = sin(pos.x * 0.1 + uTime) * 0.5 + cos(pos.y * 0.1 + uTime) * 0.5;
                            pos.z += wave * 0.5; 

                            vec3 dir = normalize(pos);
                            if (length(pos) < 0.1) dir = vec3(0.0, 0.0, 1.0);
                            pos += dir * uPinch * 30.0;
                            
                            // ‰øùÊåÅÈö®Ê©üÈñÉÁàç
                            pos.x += sin(uTime * 5.0 + randomness * 100.0) * 0.1;
                            pos.y += cos(uTime * 5.0 + randomness * 100.0) * 0.1;

                            vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                            
                            gl_PointSize = (uSize * size * (1.0 + uPinch * 1.5)) * uPixelRatio * (1.0 / -mvPosition.z);
                            gl_PointSize = min(gl_PointSize, 500.0);

                            gl_Position = projectionMatrix * mvPosition;
                            
                            vColor = color + vec3(uPinch * 0.5);
                        }
                    `,
                    fragmentShader: `
                        uniform float uOpacity; 
                        varying vec3 vColor;
                        
                        void main() {
                            vec2 xy = gl_PointCoord.xy - vec2(0.5);
                            float ll = length(xy);
                            if(ll > 0.5) discard;
                            
                            float alpha = (0.5 - ll) * 2.0;
                            alpha = pow(alpha, 2.0);

                            gl_FragColor = vec4(vColor, alpha * uOpacity);
                        }
                    `,
                    transparent: true,
                    depthWrite: false,
                    blending: THREE.AdditiveBlending
                });
            }

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // --- MediaPipe ---
        function initMediaPipe() {
            const videoElement = document.getElementById('video-input');
            const statusDot = document.getElementById('cam-status');
            const statusText = document.getElementById('status-text');

            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1, 
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onHandsResults);

            cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 640,
                height: 480
            });
        }

        function onHandsResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                handPresent = true;
                controls.autoRotate = false;

                const landmarks = results.multiHandLandmarks[0];
                
                const palmX = landmarks[9].x;
                const palmY = landmarks[9].y;
                targetRotationY = (palmX - 0.5) * 6; 
                targetRotationX = (palmY - 0.5) * 3;

                const wrist = landmarks[0];
                const middleKnuckle = landmarks[9];
                const handSize = Math.sqrt(
                    Math.pow(wrist.x - middleKnuckle.x, 2) + 
                    Math.pow(wrist.y - middleKnuckle.y, 2)
                );
                
                const minHand = 0.05; 
                const maxHand = 0.25; 
                const minZ = 50;      
                const maxZ = 300;     

                let normalizedSize = (handSize - minHand) / (maxHand - minHand);
                normalizedSize = Math.max(0, Math.min(1, normalizedSize));

                targetCameraZ = maxZ - (normalizedSize * (maxZ - minZ));

                const thumbTip = landmarks[4];
                const indexTip = landmarks[8];
                const distance = Math.sqrt(
                    Math.pow(thumbTip.x - indexTip.x, 2) + 
                    Math.pow(thumbTip.y - indexTip.y, 2)
                );

                const pinchThreshold = 0.12;
                if(distance < pinchThreshold) {
                    pinchStrength = Math.min(1, (pinchThreshold - distance) / pinchThreshold);
                } else {
                    pinchStrength = 0;
                }

            } else {
                handPresent = false;
                controls.autoRotate = false; 
                pinchStrength = Math.max(0, pinchStrength - 0.05);
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
            if(material) material.uniforms.uPixelRatio.value = renderer.getPixelRatio();
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;

            if (material) {
                material.uniforms.uTime.value = time;
                material.uniforms.uPinch.value += (pinchStrength - material.uniforms.uPinch.value) * 0.1;
            }

            // --- ÈñãÂ†¥Á©øÊ¢≠ÂãïÁï´ÈÇèËºØ (‰øÆÊîπÁÇ∫ÂÖ®Êñπ‰ΩçÁßªÂãï) ---
            if (isIntroAnimation) {
                // ÁõÆÊ®ô‰ΩçÁΩÆ
                const targetX = 0;
                const targetY = 0;
                const targetZ = 150;

                // Âπ≥ÊªëÁßªÂãïÁõ∏Ê©ü (X, Y, Z ÈÉΩË¶ÅÂãï)
                const speed = 0.03;
                camera.position.x += (targetX - camera.position.x) * speed;
                camera.position.y += (targetY - camera.position.y) * speed;
                camera.position.z += (targetZ - camera.position.z) * speed;
                
                // È£õË°åÈÅéÁ®ã‰∏≠ÊåÅÁ∫åÂ∞çÁÑ¶‰∏≠ÂøÉÔºåÁî¢ÁîüÊóãËΩâÊïàÊûú
                camera.lookAt(0, 0, 0);

                // Ë®àÁÆóËàáÁõÆÊ®ôÈªûÁöÑË∑ùÈõ¢
                const dist = camera.position.distanceTo(new THREE.Vector3(targetX, targetY, targetZ));
                
                // Ê™¢Êü•ÊòØÂê¶Êé•ËøëÁõÆÊ®ô
                if (dist < 1.0) {
                    // 1. Âº∑Âà∂Â∞çÈΩäÁõÆÊ®ôÈªû
                    camera.position.set(targetX, targetY, targetZ);
                    camera.lookAt(0, 0, 0);
                    
                    isIntroAnimation = false;
                    
                    // 2. ÂïüÁî®ÊéßÂà∂Âô®
                    controls.enabled = true;
                    
                    // 3. ÈóúÈçµ‰øÆÊ≠£ÔºöÊö´ÊôÇÈóúÈñâÈòªÂ∞º‰∏¶Êõ¥Êñ∞Ôºå‰ª•Ê∂àÈô§ÂàáÊèõÁû¨ÈñìÁöÑÊÖ£ÊÄßË∑≥Âãï
                    controls.enableDamping = false;
                    controls.update(); 
                    controls.enableDamping = true; // ÊÅ¢Âæ©ÈòªÂ∞º
                }
            } else {
                // Ê≠£Â∏∏Ê®°Âºè‰∏ãÁöÑÊéßÂà∂ÈÇèËºØ
                controls.update();

                if (handPresent) {
                    if(particles) {
                        particles.rotation.y += (targetRotationY - particles.rotation.y) * 0.08;
                        particles.rotation.x += (targetRotationX - particles.rotation.x) * 0.08;
                    }
                    camera.position.z += (targetCameraZ - camera.position.z) * 0.04;
                } else {
                    if(particles && params.floating) {
                        const speed = params.floatSpeed;
                        const targetX = Math.sin(time * 0.3 * speed) * 0.15;
                        particles.rotation.x += (targetX - particles.rotation.x) * 0.02;

                        const maxAngle = Math.PI / 4; 
                        const rawWave = (Math.sin(time * 0.5 * speed) + Math.cos(time * 0.2 * speed));
                        const targetY = (rawWave / 2) * maxAngle;
                        
                        particles.rotation.y += (targetY - particles.rotation.y) * 0.02;
                    }
                }
            }

            composer.render();
        }
    </script>
</body>
</html>
